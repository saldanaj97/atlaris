name: Code Duplicates

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - '.jscpd.json'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-duplication:
    name: Code Duplication Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run duplication check
        run: pnpm exec jscpd --exitCode 0
      - name: Generate duplication report
        if: always()
        run: |
          echo "## ðŸ” Code Duplication Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f jscpd-report/jscpd-report.json ]; then
            DUPLICATION=$(jq -r '.total.duplicatedLines // 0' jscpd-report/jscpd-report.json 2>/dev/null || echo "0")
            TOTAL=$(jq -r '.total.lines // 0' jscpd-report/jscpd-report.json 2>/dev/null || echo "0")
            if [ "$TOTAL" -gt 0 ]; then
              PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($DUPLICATION/$TOTAL)*100}")
            else
              PERCENTAGE="0.00"
            fi
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Duplicated Lines | $DUPLICATION |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Lines | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Duplication % | $PERCENTAGE% |" >> $GITHUB_STEP_SUMMARY
            echo "| Threshold | 5% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$PERCENTAGE > 5" | bc -l) )); then
              echo "âš ï¸ **Duplication exceeds 5% threshold**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Duplication within acceptable limits**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… No duplication detected" >> $GITHUB_STEP_SUMMARY
          fi
