name: Deploy - Production

on:
  workflow_call:
    inputs:
      deploy_migrations:
        description: 'Whether to run database migrations'
        required: true
        type: boolean
      deploy_workers:
        description: 'Whether to deploy worker container'
        required: true
        type: boolean
      deploy_regenerator:
        description: 'Whether to deploy regenerator container'
        required: true
        type: boolean
  workflow_dispatch:
    inputs:
      deploy_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: true
      deploy_workers:
        description: 'Deploy worker container'
        required: false
        type: boolean
        default: true
      deploy_regenerator:
        description: 'Deploy regenerator container'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  actions: read
  deployments: write

concurrency:
  group: deploy-production
  cancel-in-progress: false # Never cancel production deployments

jobs:
  migrate-database:
    name: Migrate Database (Production)
    if: inputs.deploy_migrations
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Wake up Neon database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Waking up Neon database (may be scaled to zero)..."
          for i in 1 2 3 4 5 6; do
            echo "Attempt $i/6..."
            if psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1; then
              echo "Database awake and ready"
              exit 0
            fi
            echo "Not ready, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to wake database after 6 attempts"
          exit 1
      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_URL_NON_POOLING: ${{ secrets.DATABASE_URL_NON_POOLING }}
        run: pnpm db:migrate
      - name: Verify migration success
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_URL_NON_POOLING: ${{ secrets.DATABASE_URL_NON_POOLING }}
        run: |
          echo "Migration completed successfully"

  deploy-worker:
    name: Deploy Plan Generator (Production)
    needs: [migrate-database]
    if: always() && inputs.deploy_workers && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --config fly.prod.worker.toml \
            --app atlaris-worker-prod \
            --wait-timeout 300
      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl status --app atlaris-worker-prod

  deploy-regenerator:
    name: Deploy Plan Regenerator (Production)
    needs: [migrate-database]
    if: always() && inputs.deploy_regenerator && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --config fly.prod.regenerator.toml \
            --app atlaris-worker-regenerator-prod \
            --wait-timeout 300
      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl status --app atlaris-worker-regenerator-prod

  report-status:
    name: Report Deployment Status (Production)
    needs: [migrate-database, deploy-worker, deploy-regenerator]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment status
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Migration
          if [ "${{ inputs.deploy_migrations }}" != "true" ]; then
            echo "| Migrations | ⏭️ Not requested |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.migrate-database.result }}" == "success" ]; then
            echo "| Migrations | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Migrations | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Worker
          if [ "${{ inputs.deploy_workers }}" != "true" ]; then
            echo "| Plan Generator | ⏭️ Not requested |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-worker.result }}" == "success" ]; then
            echo "| Plan Generator | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Plan Generator | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Regenerator
          if [ "${{ inputs.deploy_regenerator }}" != "true" ]; then
            echo "| Plan Regenerator | ⏭️ Not requested |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-regenerator.result }}" == "success" ]; then
            echo "| Plan Regenerator | ✅ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Plan Regenerator | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Determine overall status
          FAILED=0
          for result in "${{ needs.migrate-database.result }}" "${{ needs.deploy-worker.result }}" "${{ needs.deploy-regenerator.result }}"; do
            if [ "$result" != "success" ] && [ "$result" != "skipped" ]; then
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Deployment failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **Deployment successful**" >> $GITHUB_STEP_SUMMARY
          fi

# Note: Next.js deploys automatically via Vercel GitHub integration
