name: Deploy - Production

on:
  # Trigger automatically when CI succeeds on main
  workflow_run:
    workflows: ['CI - Main (trunk)']
    types: [completed]
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  deployments: write

concurrency:
  group: deploy-production
  cancel-in-progress: false # Never cancel production deployments

jobs:
  # Gate: Verify CI passed (for workflow_run trigger) or skip (for manual trigger)
  validate-trigger:
    name: Validate Deployment Trigger
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check trigger conditions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // For manual trigger, always proceed
            if (context.eventName === 'workflow_dispatch') {
              core.info('Manual trigger detected - proceeding with deployment');
              core.setOutput('should_deploy', 'true');
              return;
            }

            // For workflow_run trigger, check if CI passed
            const conclusion = context.payload.workflow_run?.conclusion;
            const workflowName = context.payload.workflow_run?.name;

            core.info(`Triggered by: ${workflowName}`);
            core.info(`CI conclusion: ${conclusion}`);

            if (conclusion === 'success') {
              core.info('CI passed ‚úÖ - proceeding with deployment');
              core.setOutput('should_deploy', 'true');
            } else {
              core.info(`CI did not pass (${conclusion}) - skipping deployment`);
              core.setOutput('should_deploy', 'false');
            }

  # Gate: Verify staging is healthy (wait for any in-progress staging deployment first)
  check-staging:
    name: Verify Staging is Healthy
    needs: [validate-trigger]
    if: needs.validate-trigger.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Wait for staging deployment and verify status
        uses: actions/github-script@v7
        with:
          script: |
            const maxWaitMinutes = 8;
            const pollIntervalSeconds = 30;
            const maxAttempts = (maxWaitMinutes * 60) / pollIntervalSeconds;

            // First, wait for any in-progress staging deployments to complete
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data: inProgress } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-staging.yml',
                branch: 'staging',
                status: 'in_progress',
                per_page: 1
              });

              const { data: queued } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'deploy-staging.yml',
                branch: 'staging',
                status: 'queued',
                per_page: 1
              });

              const hasRunningStaging = inProgress.workflow_runs.length > 0 || queued.workflow_runs.length > 0;

              if (!hasRunningStaging) {
                core.info('No staging deployment in progress ‚úÖ');
                break;
              }

              if (attempt === maxAttempts) {
                core.setFailed('Timeout waiting for staging deployment to complete');
                return;
              }

              const runningRun = inProgress.workflow_runs[0] || queued.workflow_runs[0];
              core.info(`Staging deployment in progress (run #${runningRun.run_number}), waiting... (attempt ${attempt}/${maxAttempts})`);
              await new Promise(resolve => setTimeout(resolve, pollIntervalSeconds * 1000));
            }

            // Now check the last completed staging deployment
            const { data: workflows } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-staging.yml',
              branch: 'staging',
              status: 'completed',
              per_page: 1
            });

            if (workflows.workflow_runs.length === 0) {
              core.setFailed('No staging deployment found');
              return;
            }

            const lastStagingDeploy = workflows.workflow_runs[0];

            if (lastStagingDeploy.conclusion !== 'success') {
              core.setFailed(`Last staging deployment failed: ${lastStagingDeploy.conclusion}`);
              return;
            }

            core.info(`Last staging deployment passed ‚úÖ (run #${lastStagingDeploy.run_number})`);

  # NEW: Detect what actually changed
  changes:
    name: Detect Changes
    needs: [validate-trigger, check-staging]
    if: needs.validate-trigger.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.filter.outputs.workers }}
      regenerator: ${{ steps.filter.outputs.regenerator }}
      migrations: ${{ steps.filter.outputs.migrations }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get comparison base
        id: get-base
        run: |
          # For workflow_run, compare against previous commit on main
          # For workflow_dispatch, we'll deploy everything (no base comparison)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "base=" >> $GITHUB_OUTPUT
            echo "Manual trigger - will deploy all components"
          else
            # Get the previous commit on main branch
            git log --oneline -5
            PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
            echo "base=${PREV_SHA}" >> $GITHUB_OUTPUT
            echo "Comparing against: ${PREV_SHA}"
          fi

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ steps.get-base.outputs.base }}
          filters: |
            workers:
              - 'src/workers/**'
              - 'src/lib/db/**'
              - 'Dockerfile.worker'
              - 'fly.prod.worker.toml'
              - 'package.json'
              - 'pnpm-lock.yaml'
            regenerator:
              - 'src/workers/**'
              - 'src/lib/db/**'
              - 'Dockerfile.worker'
              - 'fly.prod.regenerator.toml'
              - 'package.json'
              - 'pnpm-lock.yaml'
            migrations:
              - 'src/lib/db/migrations/*.sql'
              - 'src/lib/db/migrations/meta/**'
              - 'src/lib/db/schema/**'
              - 'src/lib/db/enums.ts'
              - 'drizzle.config.ts'

      - name: Log detected changes
        run: |
          echo "## üìä Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changes Detected |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workers (Plan Generator) | ${{ steps.filter.outputs.workers }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Regenerator | ${{ steps.filter.outputs.regenerator }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations | ${{ steps.filter.outputs.migrations }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "‚ö†Ô∏è **Manual trigger - deploying all components regardless of changes**" >> $GITHUB_STEP_SUMMARY
          fi

  # Step 1: Run database migrations (only if schema changed)
  migrate-database:
    name: Migrate Database (Production)
    needs: [check-staging, changes]
    if: needs.validate-trigger.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      migration_status: ${{ steps.migration-result.outputs.status }}
    steps:
      # Handle skip case explicitly
      - name: Skip - No migration changes detected
        id: skip-check
        if: needs.changes.outputs.migrations != 'true' && github.event_name != 'workflow_dispatch'
        run: |
          echo "## ‚è≠Ô∏è Database Migration Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected in:" >> $GITHUB_STEP_SUMMARY
          echo "- `src/lib/db/migrations/*.sql`" >> $GITHUB_STEP_SUMMARY
          echo "- `src/lib/db/schema/**`" >> $GITHUB_STEP_SUMMARY
          echo "- `src/lib/db/enums.ts`" >> $GITHUB_STEP_SUMMARY
          echo "- `drizzle.config.ts`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Skipping migration to save time and resources." >> $GITHUB_STEP_SUMMARY
          echo "skipped=true" >> $GITHUB_OUTPUT

      - name: Checkout main branch
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Install pnpm
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup pnpm store cache
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Node.js
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        run: pnpm install --frozen-lockfile

      - name: Wake up Neon database
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Waking up Neon database (may be scaled to zero)..."
          for i in 1 2 3 4 5 6; do
            echo "Attempt $i/6..."
            if psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1; then
              echo "Database awake and ready"
              exit 0
            fi
            echo "Not ready, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to wake database after 6 attempts"
          exit 1

      - name: Run migrations
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_URL_NON_POOLING: ${{ secrets.DATABASE_URL_NON_POOLING }}
        run: pnpm db:migrate

      - name: Verify migration success
        if: needs.changes.outputs.migrations == 'true' || github.event_name == 'workflow_dispatch'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_URL_NON_POOLING: ${{ secrets.DATABASE_URL_NON_POOLING }}
        run: |
          echo "## ‚úÖ Database Migration Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Migration applied successfully to production database." >> $GITHUB_STEP_SUMMARY

      - name: Set migration result
        id: migration-result
        if: always()
        run: |
          if [ "${{ steps.skip-check.outputs.skipped }}" == "true" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
          elif [ "${{ job.status }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

  # Step 2: Deploy workers to Fly.io (only if worker code changed)
  deploy-workers:
    name: Deploy Workers (Production)
    needs: [migrate-database, changes]
    # Run if migrations succeeded OR were skipped (no changes)
    if: always() && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: atlaris-worker-prod
            config: fly.prod.worker.toml
            name: Plan Generator
            change_output: workers
          - app: atlaris-worker-regenerator-prod
            config: fly.prod.regenerator.toml
            name: Plan Regenerator
            change_output: regenerator
    steps:
      - name: Check if deployment needed
        id: should-deploy
        run: |
          CHANGES_DETECTED="${{ needs.changes.outputs[matrix.change_output] }}"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"

          echo "Changes detected for ${{ matrix.name }}: ${CHANGES_DETECTED}"
          echo "Manual trigger: ${IS_MANUAL}"

          if [ "${CHANGES_DETECTED}" == "true" ] || [ "${IS_MANUAL}" == "true" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Will deploy ${{ matrix.name }}"
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping ${{ matrix.name }} - no relevant changes"

            echo "## ‚è≠Ô∏è ${{ matrix.name }} Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes detected in worker-related files." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Monitored paths:" >> $GITHUB_STEP_SUMMARY
            echo "- `src/workers/**`" >> $GITHUB_STEP_SUMMARY
            echo "- `src/lib/db/**`" >> $GITHUB_STEP_SUMMARY
            echo "- `Dockerfile.worker`" >> $GITHUB_STEP_SUMMARY
            echo "- `${{ matrix.config }}`" >> $GITHUB_STEP_SUMMARY
            echo "- `package.json` / `pnpm-lock.yaml`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Checkout main branch
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Fly.io CLI
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy ${{ matrix.name }} to Fly.io
        if: steps.should-deploy.outputs.deploy == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "üöÄ Deploying ${{ matrix.name }}..."
          flyctl deploy \
            --config ${{ matrix.config }} \
            --app ${{ matrix.app }} \
            --wait-timeout 300

      - name: Verify deployment
        if: steps.should-deploy.outputs.deploy == 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl status --app ${{ matrix.app }}

          echo "## ‚úÖ ${{ matrix.name }} Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully deployed to `${{ matrix.app }}`" >> $GITHUB_STEP_SUMMARY

  # Note: Next.js deploys automatically via Vercel GitHub integration

  # Final: Report deployment status
  report-status:
    name: Report Deployment Status (Production)
    needs: [validate-trigger, changes, migrate-database, deploy-workers]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate deployment summary
        run: |
          echo "## üìã Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-trigger.outputs.should_deploy }}" == "false" ]; then
            echo "‚è≠Ô∏è **Deployment skipped** - CI did not pass" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          MIGRATION_RESULT="${{ needs.migrate-database.result }}"
          MIGRATION_CHANGES="${{ needs.changes.outputs.migrations }}"
          if [ "${MIGRATION_CHANGES}" != "true" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "| Database Migration | ‚è≠Ô∏è Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${MIGRATION_RESULT}" == "success" ]; then
            echo "| Database Migration | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Database Migration | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          WORKER_RESULT="${{ needs.deploy-workers.result }}"
          WORKER_CHANGES="${{ needs.changes.outputs.workers }}"
          REGEN_CHANGES="${{ needs.changes.outputs.regenerator }}"
          if [ "${WORKER_CHANGES}" != "true" ] && [ "${REGEN_CHANGES}" != "true" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "| Workers | ‚è≠Ô∏è Skipped (no changes) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${WORKER_RESULT}" == "success" ]; then
            echo "| Workers | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${WORKER_RESULT}" == "skipped" ]; then
            echo "| Workers | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Workers | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check deployment status
        run: |
          SHOULD_DEPLOY="${{ needs.validate-trigger.outputs.should_deploy }}"
          MIGRATE_RESULT="${{ needs.migrate-database.result }}"
          WORKER_RESULT="${{ needs.deploy-workers.result }}"

          if [ "${SHOULD_DEPLOY}" == "false" ]; then
            echo "‚è≠Ô∏è Production deployment skipped (CI did not pass)"
            exit 0
          fi

          MIGRATE_OK=$( [ "${MIGRATE_RESULT}" == "success" ] || [ "${MIGRATE_RESULT}" == "skipped" ] && echo "true" || echo "false" )
          WORKER_OK=$( [ "${WORKER_RESULT}" == "success" ] || [ "${WORKER_RESULT}" == "skipped" ] && echo "true" || echo "false" )

          if [ "${MIGRATE_OK}" == "true" ] && [ "${WORKER_OK}" == "true" ]; then
            echo "‚úÖ Production deployment successful"
            exit 0
          else
            echo "‚ùå Production deployment failed"
            echo "  Migration: ${MIGRATE_RESULT}"
            echo "  Workers: ${WORKER_RESULT}"
            exit 1
          fi
