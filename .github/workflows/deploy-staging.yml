name: Deploy - Staging

on:
  # Trigger automatically when CI-PR succeeds on PRs targeting main
  workflow_run:
    workflows: ['CI - PR (trunk)']
    types: [completed]
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  deployments: write

concurrency:
  group: deploy-staging
  cancel-in-progress: false # Don't cancel in-progress deployments

jobs:
  # Gate: Verify CI passed (for workflow_run trigger) or skip (for manual trigger)
  validate-trigger:
    name: Validate Deployment Trigger
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check trigger conditions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // For manual trigger, always proceed
            if (context.eventName === 'workflow_dispatch') {
              core.info('Manual trigger detected - proceeding with deployment');
              core.setOutput('should_deploy', 'true');
              return;
            }

            // For workflow_run trigger, check if CI passed
            const conclusion = context.payload.workflow_run?.conclusion;
            const workflowName = context.payload.workflow_run?.name;
            const headBranch = context.payload.workflow_run?.head_branch;

            core.info(`Triggered by: ${workflowName}`);
            core.info(`Head branch: ${headBranch}`);
            core.info(`CI conclusion: ${conclusion}`);

            // Only deploy if CI passed and it's from staging branch PR
            if (conclusion === 'success' && headBranch === 'staging') {
              core.info('CI passed for staging PR ✅ - proceeding with deployment');
              core.setOutput('should_deploy', 'true');
            } else if (conclusion === 'success') {
              core.info(`CI passed but head branch is ${headBranch}, not staging - skipping deployment`);
              core.setOutput('should_deploy', 'false');
            } else {
              core.info(`CI did not pass (${conclusion}) - skipping deployment`);
              core.setOutput('should_deploy', 'false');
            }

  # Step 1: Run database migrations
  # Note: CI checks (lint, type-check, build) are handled by ci-pr.yml before merge
  migrate-database:
    name: Migrate Database (Staging)
    needs: [validate-trigger]
    if: needs.validate-trigger.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup pnpm store cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wake up Neon database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
        run: |
          echo "Waking up Neon database (may be scaled to zero)..."
          for i in 1 2 3 4 5 6; do
            echo "Attempt $i/6..."
            if psql "$DATABASE_URL" -c "SELECT 1" > /dev/null 2>&1; then
              echo "Database awake and ready"
              exit 0
            fi
            echo "Not ready, waiting 10 seconds before retry..."
            sleep 10
          done
          echo "Failed to wake database after 6 attempts"
          exit 1

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
          DATABASE_URL_NON_POOLING: ${{ secrets.DATABASE_URL_STAGING_NON_POOLING }}
        run: pnpm db:migrate

      - name: Verify migration success
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}
          DATABASE_URL_NON_POOLING: ${{ secrets.DATABASE_URL_STAGING_NON_POOLING }}
        run: |
          echo "Migration completed successfully"
          # Optional: Add a query to verify schema version

  # Step 2: Deploy workers to Fly.io
  deploy-workers:
    name: Deploy Workers (Staging)
    needs: [migrate-database]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - app: atlaris-worker-staging
            config: fly.staging.worker.toml
            name: Plan Generator
          - app: atlaris-worker-regenerator-staging
            config: fly.staging.regenerator.toml
            name: Plan Regenerator
    steps:
      - name: Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: staging

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy ${{ matrix.name }} to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --config ${{ matrix.config }} \
            --app ${{ matrix.app }} \
            --wait-timeout 300

      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl status --app ${{ matrix.app }}

  # Note: Next.js deploys automatically via Vercel GitHub integration

  # Final: Report deployment status
  report-status:
    name: Report Deployment Status (Staging)
    needs: [validate-trigger, deploy-workers]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.validate-trigger.outputs.should_deploy }}" == "false" ]; then
            echo "⏭️ Staging deployment skipped (CI did not pass or not from staging branch)"
            exit 0
          elif [ "${{ needs.deploy-workers.result }}" == "success" ]; then
            echo "✅ Staging deployment successful"
            exit 0
          elif [ "${{ needs.deploy-workers.result }}" == "skipped" ]; then
            echo "⏭️ Staging deployment skipped"
            exit 0
          else
            echo "❌ Staging deployment failed"
            exit 1
          fi
