name: Preview Schema Diff

on:
  deployment_status:

env:
  NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
  NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
  NEON_DATABASE_NAME: ${{ secrets.NEON_PROD_DATABASE_NAME || 'neondb' }}

jobs:
  schema-diff:
    if: >
      github.event.deployment_status.state == 'success' &&
      (contains(github.event.deployment.environment, 'Preview') || contains(github.event.deployment.environment, 'preview'))
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Resolve branch and PR number
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          branch_ref="${{ github.event.deployment.ref }}"
          branch_name="${branch_ref#refs/heads/}"

          if [ -z "$branch_name" ]; then
            echo "No branch ref on deployment event; skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pr_number=$(gh pr list --repo "${{ github.repository }}" --head "$branch_name" --state open --json number --jq '.[0].number')
          if [ -z "$pr_number" ] || [ "$pr_number" = "null" ]; then
            echo "No open PR found for branch '$branch_name'; skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "branch_name=$branch_name" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

      - name: Generate schema diff
        if: steps.resolve.outputs.skip == 'false'
        id: schema_diff
        uses: neondatabase/schema-diff-action@v1
        env:
          ENVIRONMENT: development
        with:
          project_id: ${{ env.NEON_PROJECT_ID }}
          compare_branch: preview/${{ steps.resolve.outputs.branch_name }}
          api_key: ${{ env.NEON_API_KEY }}
          database: ${{ env.NEON_DATABASE_NAME }}

      - name: Resolve preview links
        if: steps.resolve.outputs.skip == 'false'
        id: links
        env:
          PREVIEW_ENV_URL: ${{ github.event.deployment_status.environment_url }}
          DEPLOYMENT_ENV_URL: ${{ github.event.deployment.environment_url }}
          PREVIEW_TARGET_URL: ${{ github.event.deployment_status.target_url }}
          BRANCH_NAME: preview/${{ steps.resolve.outputs.branch_name }}
        run: |
          preview_url="$PREVIEW_ENV_URL"
          if [ -z "$preview_url" ] || [ "$preview_url" = "null" ]; then
            preview_url="$DEPLOYMENT_ENV_URL"
          fi
          if [ -z "$preview_url" ] || [ "$preview_url" = "null" ]; then
            preview_url="$PREVIEW_TARGET_URL"
          fi
          if [ -z "$preview_url" ] || [ "$preview_url" = "null" ]; then
            preview_url="https://vercel.com/dashboard"
          fi

          branches_url="https://console.neon.tech/app/projects/${NEON_PROJECT_ID}/branches"
          api_url="https://console.neon.tech/api/v2/projects/${NEON_PROJECT_ID}/branches"
          branch_id=""
          set +e
          branch_id=$(curl --silent --show-error \
            -H "Authorization: Bearer ${NEON_API_KEY}" \
            "$api_url" | jq -r --arg name "$BRANCH_NAME" '.branches[] | select(.name == $name) | .id' | head -n 1)
          set -e

          neon_branch_url="$branches_url"
          if [ -n "$branch_id" ] && [ "$branch_id" != "null" ]; then
            neon_branch_url="$branches_url/$branch_id"
          fi

          echo "preview_url=$preview_url" >> "$GITHUB_OUTPUT"
          echo "neon_branch_url=$neon_branch_url" >> "$GITHUB_OUTPUT"

      - name: Delete stale preview deployment comment
        if: steps.resolve.outputs.skip == 'false'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.resolve.outputs.pr_number }}
          comment-tag: preview-deployment
          mode: delete

      - name: Post preview deployment comment
        if: steps.resolve.outputs.skip == 'false'
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.resolve.outputs.pr_number }}
          comment-tag: preview-deployment
          message: |
            **Preview Deployment**

            | Resource | Link |
            |----------|------|
            | Vercel Preview | ${{ steps.links.outputs.preview_url }} |
            | Neon Branch | [Console](${{ steps.links.outputs.neon_branch_url }}) |

      - name: Delete stale schema diff comment before repost
        if: steps.resolve.outputs.skip == 'false' && steps.schema_diff.outputs.diff != ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.resolve.outputs.pr_number }}
          comment-tag: preview-schema-diff
          mode: delete

      - name: Post schema diff comment
        if: steps.resolve.outputs.skip == 'false' && steps.schema_diff.outputs.diff != ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.resolve.outputs.pr_number }}
          comment-tag: preview-schema-diff
          message: |
            **Preview Schema Diff**

            - Compare branch: `preview/${{ steps.resolve.outputs.branch_name }}`
            - Neon project: `https://console.neon.tech/app/projects/${{ env.NEON_PROJECT_ID }}/branches`

            ```diff
            ${{ steps.schema_diff.outputs.diff }}
            ```

      - name: Delete stale schema diff comment
        if: steps.resolve.outputs.skip == 'false' && steps.schema_diff.outputs.diff == ''
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ steps.resolve.outputs.pr_number }}
          comment-tag: preview-schema-diff
          mode: delete
