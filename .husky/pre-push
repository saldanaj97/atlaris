#!/bin/sh

# Check if only .md files are being pushed
check_only_md_files() {
  local remote_sha=$1

  # Get the list of changed files
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch, compare with main/origin
    changed_files=$(git diff --name-only origin/main 2>/dev/null || git diff --name-only --cached)
  else
    # Existing branch, compare with remote
    changed_files=$(git diff --name-only "$remote_sha" HEAD)
  fi

  # If no changed files, allow push
  if [ -z "$changed_files" ]; then
    return 1
  fi

  # Check if all changed files are .md files
  non_md_files=$(echo "$changed_files" | grep -v '\.md$' || true)

  if [ -z "$non_md_files" ]; then
    return 0  # Only .md files
  else
    return 1  # Non-.md files exist
  fi
}

# Read the remote and remote branch being pushed to
while read local_ref local_sha remote_ref remote_sha
do
  # Check if only .md files are being pushed
  if check_only_md_files "$remote_sha"; then
    echo "Only .md files detected in push. Skipping CI checks."
    continue
  fi

  # Run lint and type-check for all pushes
  echo "Running pre-push checks (lint and type-check)..."
  pnpm lint:fix || exit 1
  pnpm type-check || exit 1

  echo "Pre-push checks passed!"
done