#!/bin/sh

# Check if only ignorable files are being pushed (matching CI paths-ignore)
# Ignored patterns:
#   - **/*.md (Markdown files)
#   - docs/** (Documentation folder)
#   - specs/** (Specs folder)
#   - **/*.txt (Text files)
#   - **/*.csv (CSV files)
#   - **/*.log (Log files)
#   - **/*.yaml, **/*.yml (YAML configuration files)
check_only_ignorable_files() {
  local remote_sha=$1

  # Get the list of changed files
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch, compare with main/origin
    changed_files=$(git diff --name-only origin/main 2>/dev/null || git diff --name-only --cached)
  else
    # Existing branch, compare with remote
    changed_files=$(git diff --name-only "$remote_sha" HEAD)
  fi

  # If no changed files, allow push
  if [ -z "$changed_files" ]; then
    return 1
  fi

  # Filter out all ignorable files (matching CI paths-ignore patterns)
  # Remove: *.md, docs/**, specs/**, *.txt, *.csv, *.log, *.yaml, *.yml
  code_files=$(echo "$changed_files" | \
    grep -v '\.md$' | \
    grep -v '^docs/' | \
    grep -v '^specs/' | \
    grep -v '\.txt$' | \
    grep -v '\.csv$' | \
    grep -v '\.log$' | \
    grep -v '\.yaml$' | \
    grep -v '\.yml$' || true)

  if [ -z "$code_files" ]; then
    return 0  # Only ignorable files
  else
    return 1  # Code files exist that need checking
  fi
}

# Check if specific directories have changes
has_changes_in() {
  local dir=$1
  local remote_sha=$2

  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    changed_files=$(git diff --name-only origin/main 2>/dev/null || git diff --name-only --cached)
  else
    changed_files=$(git diff --name-only "$remote_sha" HEAD)
  fi

  echo "$changed_files" | grep -q "^${dir}/" && return 0 || return 1
}

# Read the remote and remote branch being pushed to
while read local_ref local_sha remote_ref remote_sha
do
  # Check if only ignorable files are being pushed
  if check_only_ignorable_files "$remote_sha"; then
    echo "Only documentation/config files detected (md, docs/*, specs/*, txt, csv, log, yaml, yml). Skipping CI checks."
    continue
  fi

  echo "Running pre-push checks in parallel..."

  # Track PIDs and their descriptions
  PIDS=""
  FAILED=0

  # Always run lint and type-check
  (pnpm lint:fix) &
  LINT_PID=$!
  PIDS="$PIDS $LINT_PID"

  (pnpm type-check) &
  TC_PID=$!
  PIDS="$PIDS $TC_PID"

  # Run unit tests if tests/unit has changes
  UNIT_PID=""
  if has_changes_in "tests/unit" "$remote_sha"; then
    echo "  → Unit tests (tests/unit has changes)"
    (pnpm test:changed) &
    UNIT_PID=$!
    PIDS="$PIDS $UNIT_PID"
  fi

  # Run integration tests if tests/integration has changes
  INT_PID=""
  if has_changes_in "tests/integration" "$remote_sha"; then
    echo "  → Integration tests (tests/integration has changes)"
    (pnpm test:integration:changed) &
    INT_PID=$!
    PIDS="$PIDS $INT_PID"
  fi

  echo "  → Lint"
  echo "  → Type-check"
  echo ""

  # Wait for each process and check exit codes
  wait $LINT_PID || { echo "❌ Lint failed"; FAILED=1; }
  wait $TC_PID || { echo "❌ Type-check failed"; FAILED=1; }

  if [ -n "$UNIT_PID" ]; then
    wait $UNIT_PID || { echo "❌ Unit tests failed"; FAILED=1; }
  fi

  if [ -n "$INT_PID" ]; then
    wait $INT_PID || { echo "❌ Integration tests failed"; FAILED=1; }
  fi

  if [ $FAILED -ne 0 ]; then
    echo ""
    echo "❌ Pre-push checks failed!"
    exit 1
  fi

  echo "✅ Pre-push checks passed!"
done