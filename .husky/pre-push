#!/bin/sh

# Check if only ignorable files are being pushed (matching CI paths-ignore)
# Ignored patterns:
#   - **/*.md (Markdown files)
#   - docs/** (Documentation folder)
#   - specs/** (Specs folder)
#   - **/*.txt (Text files)
#   - **/*.csv (CSV files)
#   - **/*.log (Log files)
#   - **/*.yaml, **/*.yml (YAML configuration files)
check_only_ignorable_files() {
  local remote_sha=$1

  # Get the list of changed files
  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch, compare with main/origin
    changed_files=$(git diff --name-only origin/main 2>/dev/null || git diff --name-only --cached)
  else
    # Existing branch, compare with remote
    changed_files=$(git diff --name-only "$remote_sha" HEAD)
  fi

  # If no changed files, allow push
  if [ -z "$changed_files" ]; then
    return 1
  fi

  # Filter out all ignorable files (matching CI paths-ignore patterns)
  # Remove: *.md, docs/**, specs/**, *.txt, *.csv, *.log, *.yaml, *.yml
  code_files=$(echo "$changed_files" | \
    grep -v '\.md$' | \
    grep -v '^docs/' | \
    grep -v '^specs/' | \
    grep -v '\.txt$' | \
    grep -v '\.csv$' | \
    grep -v '\.log$' | \
    grep -v '\.yaml$' | \
    grep -v '\.yml$' || true)

  if [ -z "$code_files" ]; then
    return 0  # Only ignorable files
  else
    return 1  # Code files exist that need checking
  fi
}

# Read the remote and remote branch being pushed to
while read local_ref local_sha remote_ref remote_sha
do
  # Check if only ignorable files are being pushed
  if check_only_ignorable_files "$remote_sha"; then
    echo "Only documentation/config files detected (md, docs/*, specs/*, txt, csv, log, yaml, yml). Skipping CI checks."
    continue
  fi

  # Run lint and type-check for all pushes
  echo "Running pre-push checks (lint and type-check)..."
  pnpm lint:fix || exit 1
  pnpm type-check || exit 1

  echo "Pre-push checks passed!"
done