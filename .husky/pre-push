set -eu

# Fast checks
pnpm type-check

# Skip tests on first commit
if git rev-list --count HEAD | grep -q '^1$'; then
  exit 0
fi

# Compute changed files vs upstream
BASE=$(git merge-base HEAD @{upstream} 2>/dev/null || echo HEAD~1)
CHANGED=$(git diff --name-only "$BASE" HEAD)

# Filter for source and unit test files
SOURCE_FILES=$(printf '%s\n' "$CHANGED" | grep -E '^(src/.*\.(ts|tsx)$|tests/unit/.*\.spec\.(ts|tsx)$)' || true)

if [ -z "$SOURCE_FILES" ]; then
  echo "No source or unit test files changed, skipping tests"
  exit 0
fi

echo "Running fast unit tests for changed files..."
SKIP_DB_TEST_SETUP=true pnpm run test:unit:related -- $SOURCE_FILES