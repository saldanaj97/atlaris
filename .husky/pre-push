set -eu

# Fast checks
pnpm type-check

# Skip tests on first commit
if git rev-list --count HEAD | grep -q '^1$'; then
  exit 0
fi

# Compute changed files vs upstream
BASE=$(git merge-base HEAD @{upstream} 2>/dev/null || echo HEAD~1)
CHANGED=$(git diff --name-only "$BASE" HEAD)

# Filter for source files (TS/TSX)
SOURCE_FILES=$(printf '%s\n' "$CHANGED" | grep -E 'src/.*\.(ts|tsx)$' || true)

if [ -z "$SOURCE_FILES" ]; then
  echo "No source files changed, skipping tests"
  exit 0
fi

# Run related unit tests
echo "Running tests for changed files..."
bash scripts/test-with-db.sh tests/unit -- --related $SOURCE_FILES
