set -eu

# Fast type-check
pnpm type-check

# Skip vitest on first commit for speed
if git rev-list --count HEAD | grep -q '^1$'; then
  exit 0
fi

# Compute changed files vs upstream
BASE=$(git merge-base HEAD @{upstream} 2>/dev/null || echo HEAD~1)
CHANGED=$(git diff --name-only "$BASE" HEAD)

# Run related unit tests for changed TS/TSX files
RELATED=$(printf '%s\n' "$CHANGED" | grep -E '\.(ts|tsx)$' || true)
if [ -n "$RELATED" ]; then
  pnpm vitest related --run $RELATED
fi
